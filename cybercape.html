<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Управление отдельными светодиодами</title>
  <style>
    /* Используем CSS для организации элементов в виде сетки */
    #ledContainer {
      display: grid;
      grid-template-columns: repeat(8, 50px);
      grid-gap: 10px;
      margin-top: 20px;
    }
    #ledContainer input[type="color"] {
      width: 50px;
      height: 50px;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Управление отдельными светодиодами</h1>
  <button onclick="connect()">Подключиться к устройству</button>
  <p id="status">Статус: не подключено</p>
  <div id="ledContainer"></div>
  
  <script>
    // Глобальные переменные для BLE
    let bleDevice;
    let bleCharacteristic;
    
    // Количество светодиодов для управления
    const LED_COUNT = 16;
    
    // Заполняем контейнер элементами выбора цвета для каждого светодиода
    const ledContainer = document.getElementById("ledContainer");
    for (let i = 0; i < LED_COUNT; i++) {
      // Создаем input для выбора цвета
      const colorPicker = document.createElement("input");
      colorPicker.type = "color";
      colorPicker.id = "led" + i;
      colorPicker.value = "#000000";  // исходный цвет (выключено)
      // При изменении цвета вызываем функцию отправки команды
      colorPicker.addEventListener("input", () => {
        sendColor(i, colorPicker.value);
      });
      ledContainer.appendChild(colorPicker);
    }
    
    // Функция для подключения к BLE устройству
    async function connect() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ name: 'ESP32_NeoPixel' }],
          optionalServices: ['4fafc201-1fb5-459e-8fcc-c5c9c331914b']
        });
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('4fafc201-1fb5-459e-8fcc-c5c9c331914b');
        bleCharacteristic = await service.getCharacteristic('beb5483e-36e1-4688-b7f5-ea07361b26a8');
        document.getElementById("status").innerText = "Статус: подключено";
        console.log("Соединение установлено");
        alert("Соединение установлено");
      } catch (error) {
        console.error("Ошибка подключения:", error);
        alert("Ошибка подключения: " + error);
      }
    }
    
    // Функция для преобразования HEX-цвета в объект с RGB-компонентами
    function hexToRgb(hex) {
      hex = hex.replace(/^#/, '');
      if (hex.length === 3) {
        hex = hex.split('').map(c => c + c).join('');
      }
      const bigint = parseInt(hex, 16);
      const r = (bigint >> 16) & 255;
      const g = (bigint >> 8) & 255;
      const b = bigint & 255;
      return { r, g, b };
    }
    
    // Функция для отправки BLE команды с цветом для конкретного светодиода
    async function sendColor(ledIndex, hexColor) {
      if (!bleCharacteristic) {
        console.error("BLE устройство не подключено");
        return;
      }
      const rgb = hexToRgb(hexColor);
      // Формируем строковую команду, например: "I3:R123,G45,B67" для светодиода с индексом 3
      const command = `I${ledIndex}:R${rgb.r},G${rgb.g},B${rgb.b}`;
      console.log("Отправка команды:", command);
      try {
        const encoder = new TextEncoder();
        const data = encoder.encode(command);
        await bleCharacteristic.writeValue(data);
        console.log("Команда отправлена успешно");
      } catch (error) {
        console.error("Ошибка отправки команды:", error);
      }
    }
  </script>
</body>
</html>
