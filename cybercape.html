<!DOCTYPE html>
<html>
<head><meta charset="utf-8"><title>Frame‑LED Control</title>
<style>
  body { font-family:sans-serif; text-align:center }
  #strips { display:flex; justify-content:space-around; margin-top:20px }
  .strip { display:grid; grid-template-rows:repeat(8,40px); gap:5px }
  input[type=color] { width:40px; height:40px; border:none }
  #controls, #anims { margin:15px }
  #controls input, #controls button,
  #anims button { margin:0 5px; padding:5px 10px }
</style>
</head>
<body>
  <h1>Frame‑LED Control</h1>
  <button onclick="connect()">Connect</button>
  <p id="status">Disconnected</p>

  <div id="strips">
    <div class="strip" id="s1"></div>
    <div class="strip" id="s2"></div>
  </div>

  <div id="controls">
    <input type="color" id="c1" value="#ff0000">
    <button onclick="quick(0,8,'c1')">All Strip 1</button>
    <input type="color" id="c2" value="#00ff00">
    <button onclick="quick(8,16,'c2')">All Strip 2</button>
    <input type="color" id="call" value="#0000ff">
    <button onclick="quick(0,16,'call')">All LEDs</button>
  </div>

  <div id="anims">
    <button onclick="animBlink()">Blink</button>
    <button onclick="animChase()">Chase</button>
    <button onclick="animRainbow()">Rainbow</button>
  </div>

<script>
let charac, LEDS=16;
let picks = [];

// создаём цветопики
for(let i=0;i<LEDS;i++){
  let p = document.createElement('input');
  p.type='color'; p.value='#000';
  p.oninput = ()=> frameSend([{i,hex:p.value}]);
  picks.push(p);
  (i<8?document.getElementById('s1'):document.getElementById('s2')).append(p);
}

async function connect(){
  const dev = await navigator.bluetooth.requestDevice({
    filters:[{name:'ESP32_Frame'}],
    optionalServices:['4fafc201-1fb5-459e-8fcc-c5c9c331914b']
  });
  const srv = await dev.gatt.connect();
  const svc = await srv.getPrimaryService('4fafc201-1fb5-459e-8fcc-c5c9c331914b');
  charac = await svc.getCharacteristic('beb5483e-36e1-4688-b7f5-ea07361b26a8');
  await charac.startNotifications();
  charac.addEventListener('characteristicvaluechanged', onNotify);
  document.getElementById('status').innerText='Connected';
}

// обновление полного кадра — приход уведомления
function onNotify(e){
  let dv = e.target.value;
  for(let i=0;i<LEDS;i++){
    let r=dv.getUint8(i*3), g=dv.getUint8(i*3+1), b=dv.getUint8(i*3+2);
    let hx = '#'+((1<<24)|(r<<16)|(g<<8)|b).toString(16).slice(1);
    picks[i].value = hx;
  }
}

// отправка единого кадра из массива {i,hex}
async function frameSend(arr){
  let buf = new Uint8Array(1 + arr.length*4);
  buf[0] = arr.length;
  arr.forEach((x,idx)=>{
    let rgb = hexToRgb(document.getElementById(x.hex?x.hex:'') || x.hex || x);
    let base = 1 + idx*4;
    buf[base]   = x.i;
    buf[base+1] = rgb.r;
    buf[base+2] = rgb.g;
    buf[base+3] = rgb.b;
  });
  await charac.writeValue(buf);
}

function quick(s,e,id){
  let h = document.getElementById(id).value;
  let arr = [];
  for(let i=s;i<e;i++) arr.push({i,hex:h});
  frameSend(arr);
}

function hexToRgb(hex){
  hex=hex.replace('#','');
  if(hex.length==3) hex=hex.split('').map(h=>h+h).join('');
  let n=parseInt(hex,16);
  return {r:n>>16&255, g:n>>8&255, b:n&255};
}

// анимации примеры
async function animBlink(){
  for(let k=0;k<6;k++){
    quick(0,16, (k%2? 'call':'call'));
    await new Promise(r=>setTimeout(r,300));
  }
}
async function animChase(){
  await quick(0,16,'call');  
  for(let i=0;i<LEDS;i++){
    await frameSend([{i,hex:'#f00'}]);
    await new Promise(r=>setTimeout(r,100));
    await frameSend([{i,hex:'#000'}]);
  }
}
async function animRainbow(){
  const wheel = p=>{
    p = 255-p; if(p<85) return {r:255-p*3,g:0,b:p*3};
    if(p<170) return {p:p-85, r:0, g:p*3, b:255-p*3};
    p-=170; return {r:p*3,g:255-p*3,b:0};
  };
  for(let j=0;j<256;j+=16){
    let arr=[];
    for(let i=0;i<LEDS;i++){
      let c=wheel((i*256/LEDS+j)&255);
      arr.push({i, hex:('#'+((1<<24)|(c.r<<16)|(c.g<<8)|c.b).toString(16).slice(1))});
    }
    await frameSend(arr);
    await new Promise(r=>setTimeout(r,200));
  }
}
</script>
</body>
</html>
