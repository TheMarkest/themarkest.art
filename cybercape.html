<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- :contentReference[oaicite:0]{index=0} -->
  <title>NeoPixel Control</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #content {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }
    /* Нижнее меню навигации */
    .navbar {
      position: fixed;           /* заставляем меню быть всегда внизу */  
      bottom: 0;                 
      left: 0;
      width: 100%;               
      background: #333;          
      display: flex;             
      justify-content: space-around;
      align-items: center;
      color: #fff;
      z-index: 1000;
    }
    .navbar button {
      background: none;
      border: none;
      color: inherit;
      padding: 10px 5px;
      font-size: 0.9rem;
      flex: 1;
      cursor: pointer;
    }
    .navbar button.active {
      background: #555;
    }                          <!-- :contentReference[oaicite:1]{index=1} -->

    /* Скрываем все разделы по умолчанию */
    section { display: none; }
    section.active { display: block; }

    /* Адаптивность для узких экранов */
    @media (max-width: 600px) {
      .led-column { grid-template-rows: repeat(8, 35px); }  <!-- :contentReference[oaicite:2]{index=2} -->
      .navbar button { font-size: 0.8rem; padding: 8px 3px; }
    }
  </style>
</head>
<body>
  <div id="content">
    <!-- Разделы управления -->
    <section id="setup" class="active">
      <h2>Настройка и подключение</h2>
      <button onclick="connect()">Подключиться</button>
      <p id="status">Статус: не подключено</p>
    </section>

    <section id="manual">
      <h2>Ручное задание цветов</h2>
      <div id="strip1" class="led-column"></div>
      <div id="strip2" class="led-column"></div>
    </section>

    <section id="animations">
      <h2>Анимации</h2>
      <button onclick="startAnimation('blink')">Мигание</button>
      <button onclick="startAnimation('chase')">Бегущий огонь</button>
      <button onclick="startAnimation('rainbow')">Радуга</button>
    </section>

    <section id="strobe">
      <h2>Стробоскоп</h2>
      <label>Цвет: <input type="color" id="strobeColor" value="#ffffff"></label>
      <label>Частота (Гц): <input type="number" id="strobeFreq" min="1" max="20" value="5"></label>
      <label>Длительность импульса (мс): <input type="number" id="strobePulse" min="10" max="500" value="100"></label>
      <button onclick="startStrobe()">Старт</button>
      <button onclick="stopStrobe()">Стоп</button>
    </section>

    <section id="music">
      <h2>Цветомузыка</h2>
      <button onclick="initAudio()">Разрешить микрофон</button>
      <label>Цвет: <input type="color" id="musicColor" value="#00ff00"></label>
      <label>Яркость макс (%): <input type="range" id="musicBrightness" min="0" max="100" value="50"></label>
      <button onclick="startMusic()">Старт</button>
      <button onclick="stopMusic()">Стоп</button>
    </section>
  </div>

  <div class="navbar">
    <button class="nav-btn active" data-target="setup">Настройка</button>
    <button class="nav-btn" data-target="manual">Ручное</button>
    <button class="nav-btn" data-target="animations">Анимации</button>
    <button class="nav-btn" data-target="strobe">Стробоскоп</button>
    <button class="nav-btn" data-target="music">Цветомузыка</button>
  </div>

  <script>
    // Навигация по разделам
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(btn.dataset.target).classList.add('active');
        btn.classList.add('active');
      });
    });  <!-- :contentReference[oaicite:3]{index=3} -->

    // BLE, Manual, Animations, Strobe и Music будут объявлены ниже...
    async function connect() { /* ... */ }         <!-- :contentReference[oaicite:4]{index=4} -->
    function startAnimation(name) { /* ... */ }    <!-- :contentReference[oaicite:5]{index=5} -->
    let strobeInterval;
    function startStrobe() {
      const color = document.getElementById('strobeColor').value;  <!-- :contentReference[oaicite:6]{index=6} -->
      const freq = parseFloat(document.getElementById('strobeFreq').value);
      const pulse = parseInt(document.getElementById('strobePulse').value, 10);
      if (strobeInterval) clearInterval(strobeInterval);
      strobeInterval = setInterval(() => {
        frameSend([{ i: -1, color }]);  // -1 = весь кадр белый/цвет
        setTimeout(() => frameSend([{ i: -1, color: '#000000' }]), pulse);
      }, 1000 / freq);
    }
    function stopStrobe() {
      clearInterval(strobeInterval);
    }

    // Цветомузыка через Web Audio API
    let audioCtx, analyser, dataArray, source;
    async function initAudio() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });  <!-- :contentReference[oaicite:7]{index=7} -->
      audioCtx = new AudioContext();                                              <!-- :contentReference[oaicite:8]{index=8} -->
      analyser = audioCtx.createAnalyser();
      source = audioCtx.createMediaStreamSource(stream);
      source.connect(analyser);
      dataArray = new Uint8Array(analyser.frequencyBinCount);
    }
    let musicInterval;
    function startMusic() {
      const baseColor = document.getElementById('musicColor').value;  <!-- :contentReference[oaicite:9]{index=9} -->
      const maxB = parseInt(document.getElementById('musicBrightness').value, 10);
      musicInterval = setInterval(() => {
        analyser.getByteTimeDomainData(dataArray);
        const amp = dataArray.reduce((a,v)=>a+Math.abs(v-128),0)/dataArray.length/128;
        const brightness = Math.min(1, amp) * maxB;
        // смешиваем цвет с яркостью
        const { r,g,b } = hexToRgb(baseColor);
        const scaled = `#${((1<<24)|((r*brightness/100)<<16)|((g*brightness/100)<<8)|(b*brightness/100)).toString(16).slice(1)}`;
        frameSend([{ i: -1, color: scaled }]);
      }, 50);
    }
    function stopMusic() {
      clearInterval(musicInterval);
      frameSend([{ i: -1, color: '#000000' }]);
    }

    // Общие функции: frameSend, hexToRgb и инициализация Manual/Animations...
  </script>
</body>
</html>
